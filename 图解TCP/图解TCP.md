## 网络基础知识

### 协议分层与OSI参考模型

#### 协议的分层

OSI模型分为7层，在这个模型中，每个分层都接收由其下一层所提供的特定服务，并且负责为其上一层提供特定的服务。同一层之间的交互所遵循的约定叫做协议。

这七层独立使用，即使系统中的某些分层发生变化，只要接口没变，那么系统中的其他模块就不会发生变化，类似于平常的模块化编程。

#### OSI参考模型

实际的分组通信协议相当复杂，OSI参考模型将这样一个复杂的协议整理并且分成了7个分层。

1. 应用层，为应用程序提供服务并且规定应用程序中通信相关的细节。
2. 表示层，将应用处理的信息转换为适合网络传输的格式。
3. 会话层，负责建立和断开通信连接，以及数据的分割等数据传输相关的管理。
4. 传输层，起着可靠传输的作用。只在通信双方节点上进行处理，无需在路由上处理。
5. 网络层，将数据传输到目标地址。这一层主要负责寻址和路由选择。
6. 数据链路层，负责物理层面上的互连。将0、1序列划分为有意义的数据帧传送给对端。
7. 物理层，负责0、1比特流的传递。

### OSI参考模型通信处理举例

7层通信在发送端的时候，是自上而下的，而在接收端是自下而上的。发送端的每一层在数据上附加自己的首部信息，然后作为数据传递给下一层，而接收端每一层解析报文，将报文分为首部和数据，并且将数据传递给上一层。从而将发送端发送的数据恢复原状。

#### 表示层处理

表示层将应用层的数据进行同构化，保证将数据从某个计算机特定的数据格式转换为网络通用的数据格式。

#### 会话层处理

如何进行两端的会话的建立，是建立一个连接还是多个连接，是并行发送还是串行发送，来保证两端主机的会话层之间高效地数据交互。

#### 传输层处理

进行两个主机之间的逻辑通信，何时建立连接，数据是否到达了目标主机，目标主机接收到的数据是否完整，如果不完整，那么如何进行数据的重发，这些事情主要由传输层进行处理。

#### 网络层处理

实际的逻辑数据发送是通过网络层进行的，网络层通过确认目标的地址，来确定通信线路，通过地址来将数据发送到相连的任何一台设备上面。

### 传输方式的分类

#### 面向有连接型和面向无连接型

顾名思义，就是在发送数据之前，是否需要建立确定的通信线路。有连接型需要首先和目标进行通信，建立起一个稳定的通信线路，再进行数据的发送。而面向无连接型可以直接自由发送数据。接收端也不知道自己会在何时，从哪里接收到数据。

#### 电路交换和分组交换

在电路交换中，如果两个通信端之间有交换机存在，那么必须要通过交换机建立通信电路，并且在通信完成后进行释放。因此这两端是依靠独占的线路进行数据传输的。

在分组交换中，将要发送的数据分成多个数据包，按顺序发送，当路由器接收到了这些分组数据的时候，会将这些数据放在自己的缓存队列当中，再根据数据包首部中的地址信息将这些数据一一进行转发。

#### 根据接收端数量分类

* 单播：也就是一对一的通信。
* 广播：在一个指定的范围内，将数据发送给所有的对象，这个范围叫做广播域。
* 多播：将数据发送给某个分组里面的所有对象。
* 任播：在指定的组内，选择一个对象作为接收端。

#### 地址

在实际的网络通信当中，每一层协议使用的地址都不尽相同。TCP/IP协议中使用IP地址、端口号、MAC信息等作为地址，而在应用层协议当中，可能使用电子邮件地址等作为地址标识。

##### 地址的唯一性

在同一个通信网络中，有着一个唯一的地址作为标识对象。而针对于有多个目标对象的情况，接收端的设备不止一个，这时候就需要对多个设备组成的一组通信赋予同一个具有唯一性的地址。

##### 地址的层次性

当地址总数数量很多的时候，如果所有的地址都是唯一的，那么会带来很多问题，所以，地址也需要具有层次性，也就是将地址分层，每一层的地址在自己的层次内是唯一的。

在实际的寻址过程当中，MAC地址是具有完全唯一性的地址，也是真正负责最终通信的地址，但是在实际的寻址过程中，具有层次性的IP地址必不可少。

#### 网络的构成要素

* 中继器：位于OSI模型的第1层，也就是物理层。用来将光信号或者电信号进行波形转换再发送给另外一个电缆。
* 网桥(2层交换机)：网桥是工作于数据链路层的网络设备，可以实现数据帧的有效转发，将数据帧转发至其所应该去的网络段。并且只能够在相同类型的网络中进行转发。
* 路由器(3层交换机)：在网络层面上连接两个网络、并且对分组报文进行转发的设备。
* 4~7层交换机：负责TCP协议及上层协议的数据转发。
* 网关：也是处理4~7层的网络数据，通常会使用一个表示层或者应用层网关，来对两个不能够进行直接通信的协议之间进行翻译，实现两者的通信。

## TCP/IP基础知识

### TCP/IP分层模型与通信示例

1. 应用程序处理：应用程序将需要发送的文本进行处理，编码等操作，在发送的那一刻建立TCP连接，从而利用这个TCP连接发送数据。

2. TCP模块的处理：TCP根据应用的指示，负责建立连接，发送数据、断开连接。TCP提供将应用层发来的数据顺利发送到对端，进行可靠传输。TCP为数据添加TCP首部，包含源端口号、目的端口号、校验和等。随后将TCP包发送给IP。

3. IP模块的处理：IP将TCP发送来的数据加上IP首部。IP首部包含接收端IP和发送端IP以及传输层协议标识。IP包生成后，参考路由控制表来决定将此IP发送给哪个路由或者主机。并且使用ARP解析出对端MAC地址，将这些信息发送给网络驱动程序，实现数据传输。

4. 驱动程序处理：添加上以太网首部，包含MAC地址信息，将数据包发送出去。

分组数据包经过以太网的数据链路，每个包的首部都包含发送端和接收端的地址以及上层协议的类型。而在接收的时候，就进行发送的时候的反向操作。IP模块会借助路由控制表来进行数据的转发，直到达到目标主机。而TCP模块会在计算校验和之后，判断接收到的数据是否被破坏，如果没有被破坏，就需要发送一个确认回执给发送端。

## 数据链路

### 数据链路的作用

数据链路指的是OSI参考模型中的数据链路层。数据链路层的协议定义了通过通信媒介互连的设备之间传输的规范。

### 数据链路相关技术

#### MAC地址

MAC地址用于识别数据链路中互连的节点。MAC地址长48bits，在使用网卡的情况下，MAC一般会被烧到ROM中，所以网卡的MAC地址是唯一的。

#### 共享介质型网络

较早以太网和FDDI就是介质共享型网络。在这种方式下，设备之间使用同一个载波信道进行发送和接收。所以基本采用半双工通信方式，要对通信介质进行访问控制。

访问控制的方法有两种：

1. 争用方式：在该方式下，如果有设备想要占用信道发送数据，那么首先需要监听载波信道上有没有通信正在进行，如果没有的话，才可以进行发送，但是这样如果多个设备同时发送数据帧，就会导致网络拥堵。在一部分以太网络中，会使用CSMA的改良版本CSMA/CD，每个站会提前检测冲突，一旦发生冲突，则需要尽快释放信道，并且在一段随机延时之后重试。

2. 令牌传递方式：沿着令牌环发送令牌报文，只有获得了令牌的站才能够发送数据。并且数据在令牌环中进行回环发送，如果某个站接收到的数据帧不是发送给自己的，那么就向下转发，当数据帧回到了发送站的时候，发送站释放令牌，传递给下一个站。这样，链路上就不会有冲突出现，网络拥堵也不会发生。但是，这样在网络不是非常拥堵的时候，链路的利用率比较低。

#### 非共享介质网络

在子网中，各个站都直接连向子网的交换机，所有的数据都通过交换机进行转发。这种情况下，发送端和接收端不共享通信介质。在这种情况下可以采用全双工的通信方式。这样就需要保证交换机的畅通。在使用双绞线电缆的时候，设备和交换机可以进行全双工通信。

#### 根据MAC地址转发

在介质共享网络中，同一时间只有一个设备可以发送数据。这时使用以太网交换机(也就是有多个端口的网桥)，可以根据数据链路层帧的目标MAC地址，来决定从哪个网络接口发送数据。并且这个网络接口的选择是可学习，交换机会将每次发送数据帧的端口记录下来，下次就可以直接进行发送了。

#### 环路检测技术

通过网桥连接网络的时候，一旦出现了环路，会导致发出的数据会在网络拓扑中持续不断的转发。

1. 生成树方式：每个网桥必须在每1~10秒内相互交换BPDU包，来判断哪些端口不使用，一旦发生故障则自动切换通信线路。不使用的端口会作为备用链路，来在主链路DOWN掉的时候切换到备用链路。

2. 源路由法：该方法判断发送数据的源地址是通过哪个网桥实现的，网桥根据这个信息将帧发送给目标地址。

#### VLAN

同一个网络中的计算机之间会经常进行广播或者多播，比如通过ARP协议检测目标计算机的MAC地址，这样会大量占用网络带宽，导致拥塞的发生。所以需要划分VLAN，将一个网络划分为多个子网，这种功能也可以通过物理上的直接布线进行，但是这样很麻烦，所以可以使用VLAN来划分逻辑上的子网。使用支持VLAN的二层交换机可以划分VLAN，当某台计算机发出广播请求的时候，交换机会发现自己的MAC地址表中有一个地址符合条件，那么其会直接将广播发送到对应的端口中，来防止跨越VLAN的访问。跨越VLAN的访问需要路由支持。由于路由被认为属于所有的VLAN，所以跨越VLAN的访问会首先被转发到路由中，再由路由进行分发。

### 以太网

#### 以太网连接形式

在以太网普及之初，一般采用多台终端使用同一根同轴电缆共享介质的连接方式。而现在一般采用终端和交换机之间独占电缆的方式进行连接。

#### 以太网帧格式

以太网的帧前端有一个叫做前导码的部分，由0、1数字交替组合而成，表示一个以太网帧的开始。以太网帧本体的前端是以太网的首部，总共占14个字节，包括6个字节的目标MAC地址，6个字节的源MAC地址以及2个字节的上层协议类型。在帧头后面的是数据，一个数据帧能够容纳46~1500个字节，帧的末尾是一个4字节的FCS，帧检验序列。

### 无线通信

#### 无线通信的种类

无线通信包括无线个域网(PAN:bluetooth)，无线局域网(LAN:Wi-Fi)，无线城域网(WiMAX)，无线广域网(WAN:3G,4G)等。

#### IEEE802.11

IEEE802.11定义了无线LAN协议中物理层与数据链路层的一部分。其定义的MAC层类似于以太网的MAC层，使用无线网卡中的MAC地址作为物理地址进行通信。介质访问控制上使用CSMA/CD的类似方式CSMA/CA进行。

### PPP

#### 定义

PPP(Point-to-Point Protocol)是指点对点，也就是1对1连接计算机的协议。PPP是纯粹的二层协议，不包括针对物理层的协议，不像以太网和FDDL，需要物理层的支持才可以实现通信。

### 其他数据链路

#### ATM

ATM(Asynchronous Transfer Mode)是以一个叫做信元的单位进行传输的数据链路，其线路占用时间短，并且能够进行高速的大容量数据传输。

#### FDDI

FDDI(Fiber Distributed Data Interface)叫做分布式光线数据接口。FDDI采用令牌环的访问方式。所以FDDI中的每个站通过光纤连接成环状。

## IP协议

### IP即网际协议

#### IP相当于OSI模型的第3层

IP协议相当于OSI模型中的网络层，实现终端节点之间的通信。

#### 网络层和数据链路层的关系

实际上，数据链路层负责的是两个直连节点之间的通信，每一个端对端的通信过程都可以分解为许多节点之间的通信，这些节点将数据帧进行一步步转发，直到接收端，而网络层则是对整个通信过程进行控制的。

### IP基础知识

#### IP地址属于网络层地址

在计算机通信当中，必须要有一个确定的地址才能够识别接收方，也就是对端，数据链路层使用的是MAC地址，而在网络层则是使用IP地址。

而无论主机和哪一种数据链路相连，其IP地址是保持不变的，所以数据链路对于网络层是透明的。所以二层交换机是不需要IP地址的。

#### 路由控制

路由控制是指将分组数据发送到最终的目标地址的功能。无论网络是什么样的，只要两端之间存在通路，那么路由控制就可以找到这条通路。

但是实际上的每一跳都是有链路层进行实际的传输。多跳路由是指路由器或者主机在转发IP数据包的时候仅仅指定下一个路由器或者是主机，而不是直接指出所有的通路。在数据包完成一跳的时候，就会自动被指定下一跳的方向。

为了将数据包发给目标主机，所有的主机都维护一张路由控制表，这个表记录了IP数据下一跳的方向。

#### IP属于面向无连接型

IP面向无连接，也就是在发包之前，不需要建立与对端之间的通信线路。

### IP地址的基础知识

#### IP地址的定义

IP地址又32位正整数来表示。也就是32位2进制，为了方便，将这32位2进制按照8位分开，并且将这8位用10进制表示，就形成了现在的类似`172.20.1.2`这样的IP地址。

#### IP地址由网络和主机两个部分标识组成

IP地址由网络标识和主机标识两个部分组成。IP包被转发到了某个路由器的时候，正是利用目标IP地址的网络标识进行路由的。而这两个部分现在常用子网掩码进行区分。

#### 广播地址

广播地址用于在同一个链路中相互连接的主机之间发送数据包。如果将IP地址的主机地址部分全部设置为1，就变成了广播地址。

#### IP多播

由于广播不存在路由穿透，所以如果要发送跨路由的多播，则需要使用D类地址，如果从首位开始到第四位是`1110`，就可以认为是多播地址。也就是从`224.0.0.0~239.255.255.255`之间的地址范围。对于多播，所有的主机都必须属于`224.0.0.1`的组，所有的路由都应该属于`224.0.0.2`的组。

#### 子网掩码

子网掩码也是一个32位的2进制数，对应IP地址网络标识部分的位全部为1，而对应IP地址主机标识的部分则全部为0。针对子网掩码，有两种表示方法，其一是用一个单独的32位2进制进行表示，另外一种则是在IP地址后面缀上`/xxx`进行表示，其中`xxx`表示网络地址的位数。
```
地址  : 172  20  100  52
掩码  : 255  255 255  192
11111111.11111111.11111111.11000000   (32 - 6 = 26)

地址  : 172  20  100  52  / 26
```

#### CIDR与VLSM

刚开始的时候，基本所有的地址都是按照A,B,C三类地址进行单位分类的。由于C类地址仅仅允许254台计算机相连，所以导致了C类地址的严重不足，之后，开始放弃了地址的分类，使用任意长度分割IP地址的网络标识和主机标识。这种方式叫做CIDR，也就是无类型域间选路。这样几个连续的C类地址就可以合并成一个网路了。

CIDR的初期，每个网络内部仍然使用一样长度的子网掩码，这样就导致了网络内部的IP地址浪费，因为有些部分可能主机比较多，而某些部分主机比较少。VLSM允许一个网络内部使用变长的子网掩码，这样在一定程度上提高了网络的IP地址利用率。

#### 全局地址和私有地址

随着IP地址的不足，如果每一个主机或者路由器都使用唯一的IP地址，那么势必会导致IP地址的冲突，这样会造成很大的影响。所以提出了在独立的网络内部，可以使用自由设定的私有地址，但是私有地址是在一定范围之内的。私有地址分为三类：A类：10/8，B类：172.16/12，C类：192.168/16。这三个地址之内的地址都称为私有地址，剩下的称为全局地址。

### 路由控制

#### IP地址与路由控制

IP地址的网络地址部分用于进行路由控制。路由控制表分为静态和动态两类，顾名思义，动态路由可以根据IP数据包的发送情况决定下一个数据包需要发往哪个IP的路由或者是主机。

路由控制表中记录着网络地址以及下一步应该发送至路由器的地址。在发送IP包的时候，首先需要确定IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据这个记录将IP包转发给下一个相应的路由器。如果有多个地址都符合要求，那么就选择一个最为吻合的网络地址进行发送。

有三个特殊的路由：

1. 默认路由：0.0.0.0/0，也就是所有的数据都被发送往同一个地址。
2. 主机路由：子网掩码为32位的路由，也就是指定了一个唯一的主机地址，不存在网络地址。这样的路由会导致通信不经过任何一个路由，直接达到目的地。
3. 环回地址：127.0.0.1以及localhost，这两个地址不会流向外部。

#### 路由控制表的聚合

如果有时候一个路由器的路由表有很多比较相似的路由，这些路由信息可以进行合并，这样可以最大程度上缩减路由控制表的大小，可以加快查找速度以及降低一次路由查找的CPU消耗，提升路由性能，比如可以将192.168.3.0/24以及192.168.2.0/24两个路由信息在上层路由中合并为192.168.2.0/23。

### IP分割处理与再构成处理

#### 数据链路不同，MTU则相异

每种数据链路的最大传输单元(MTU)都不相同，由于IP属于数据链路的上一层，所以其必须不能受限于数据链路的MTU大小。

#### IP报文的分片与重组

任何一台主机都有必要对IP分片进行相应的处理。分片往往在网络上遇到比较大的报文，无法一下子发送出去的时候才会进行处理。由于以太网默认的MTU为1500字节，那么一个4243字节的IP数据报文无法一次发送出去，那么就需要分成3个分片，这种分片是有路由器进行的，但是路由器不能够进行分片的重组，重组必须由目标主机进行。因为几个不同的IP分片可能走不同的网络到达目标主机，并且如果路由进行了重组，但是在发送的时候又需要进行分片，那么会在很大程度上减低路由的性能。

#### 路径MTU发现

分片机制也存在着一定的不足，主要是会导致路由的负担加重，当前的路由需要进行很多的操作，如果再进行报文的分片的话，会导致其性能下降。并且在分片处理当中，一旦一个分片丢失，会导致整个IP数据报作废。为了应对这个问题，路径MTU发现被提出，也就是在发送端到接收端之间的所有数据链路的最小MTU大小会让主机知道，主机会按照这个大小来进行分片，这样路由就被解放了出来。

针对UDP的路径MTU发现是这样的：

首先在发送端主机发送IP的时候，将其禁止MTU分片的首部设为1，这样到达的第一个需要分片的路由的时候，这个数据包会被丢弃，并且路由返回一个ICMP数据包给主机，这个ICMP数据包包含着当前路由支持的分片大小，主机按照ICMP数据包的信息进行分片，然后再次发送出去。如果某个路由器再次返回一个ICMP那么就代表着下一段数据链路的MTU更小，所以主机再次按照新的MTU大小进行分片，直到IP数据包发送到目标主机。于是最后一次收到的ICMP数据包就指定了路径上最小的MTU大小，这个大小可以被缓存，下次再进行使用。

### IPv6

#### IPv6的必要性

IPv6的出现了为了从根本上解决IPv4地址不够用的问题，IPv4的地址长度为4个8位字节，而IPv6的长度是之前的4倍，也就是8个16字节。

但是从IPv4全部替换到IPv6是需要很长时间的。

#### IPv6的特点

IPv6将很多之前IPv4没有规范的功能进行了严格的规范。

* IP地址的扩大与路由控制表的聚合：IP地址依然使用互联网分层构造。
* 性能提升：全部采用路径MTU发现，并且包首部固定为40字节，不再采用首部校验。
* 支持即插即用功能：即使没有DHCP的服务器也可以实现自动分配IP。
* 采用认证与加密功能：应对伪造IP地址的网络安全功能以及防止线路窃听的功能。
* 多播，Mobile IP称为扩展功能。

#### IPv6中IP地址的标记方法

IPv6将自己的128位地址分成8个16位地址，每个地址用冒号分开，并且如果出现连续的0还可以将0省略，但是最后出现一次两个连续的冒号。

十六进制表示：FEDC:BA98:7654:3210:FEDC:BA98:7654:3210
十六进制省略：1080:              :   8: 800:200C:417A
十六进制原本：1080:0000:0000:0000:0008:0800:200C:417A

#### IPv6的地址结构

IPv6和IPv4相同，也是通过IP地址的前几位标识IP地址的种类。

#### 全局单播地址

全局单播地址是世界上唯一的一个地址，是互联网通信以及各个域内部通信最为常用的IPv6地址。当前IPv6网络中地址的格式为：前64位是网络标识，后64位是主机标识。前64位网络标识由n位全局路由前缀和m位子网ID组成。

#### 链路本地单播地址

链路本地单播地址指在同一个数据链路内的唯一地址，用于不经过路由器的通信：

10位标识位，54位0，64位接口ID。

#### 唯一本地地址

唯一本地地址是不进行互联网通信时候的地址。其实本质上是不直接联网，还是可以通过代理或者NAT进行联网的。

7位标识，1位L(常为1)，40位全局ID，16位子网ID，64位接口ID

#### IPv6分段处理

IPv6的分片处理是在源主机上进行的，路由器不参与分片。并且使用的路径MTU发现，但是对于一些性能较差的设备，比如嵌入式设备来说，就会直接采用最小分片大小1280字节直接分片送出。

### IPv4首部

* 版本：4位，表示IP首部的版本号，IPv4用4进行表示，IPv6用6进行表示，除此之外还有一些其他的版本号，但是不是很经常使用。

* 首部长度：4位，表示IP首部的大小，单位为4个字节，如果没有可选项的IP包，首部长度设置为5，也就是20字节。

* 区分服务：8位，表示服务质量，但是这个值基本已经很少使用了，这些要求可能让应用获取很差的服务质量。现在主要使用DSCP段和ECN段，分别表示质量控制和报告网络拥堵情况。

* 总长度：16位，表示IP首部和数据部分的总长度。因为有16位，所以IP数据包的最大长度为2的16次方，也就是65535个字节

* 标识：16位，用于分片重组，同一个分片的标识值相同。每发送一个IP包，这个值会逐渐递增，这个标识和源地址，目标地址，协议几个部分共同用来区分分片。

* 标志：3位，表示包被分片的相关信息。分别表示是否允许分片以及是否为分片的最后一个包。

* 片偏移：13位，用来标识分片的每一个分段相对于原始数据的位置。单位为8个字节，也就是2的三次方+13位刚好等于IP数据包的最大大小16位。

* 生存时间：8位，现在实际上指这个数据包最多可以经过多少个路由器，每经过一个路由器，TTL会减少1，变成0的时候会丢弃这个数据包。

* 协议：8位，表示IP数据包的上层属于哪种协议，比如TCP或者UDP等。

* 首部校验和：16位，也叫做IP首部校验和，只校验数据包的首部，不校验数据部分。

* 源地址：32位，表示发送端的IP地址

* 目的地址：32位，表示接收端的IP地址

* 可选项：在进行实验或者诊断的时候使用。

* 填充：通过向该字段填充0，来将首部长度调整为32位的整数倍（方便CPU进行处理）。

* 数据：IP上层协议的整个报文，包括首部。

### IPv6首部格式

IPv6的首部和IPv4的首部相比，变化非常大，减少了首部校验和字段，并且分段的识别码也成为了可选项。为了方便64位的计算机进行处理，IPv6的首部选项都是8个字节。

* 版本：4位，和IPv4一致。

* 通信量类：8位，相当于TOS字段。

* 流标号：20位，准备用于服务质量控制(QoS)。

* 有效载荷长度：也就是指包的数据部分的长度。

* 下一个首部：8位，用来表示上层协议。

* 跳帧限制：8位，与TTL意思相同，表示可以通过的路由器个数。

* 源地址：128位。

* 目的地址：128位。

#### IPv6扩展首部

IPv6的首部长度固定，不能够将可选项加入其中，所以使用扩展首部对功能进行扩展。

扩展首部一般位于IPv6首部与数据之间，也就是IPv6首部与TCP/UDP首部之间。IPv6首部中没有标识以及标志字段，在需要对IP进行分段的时候，分段信息就可以放在扩展首部内。

## IP协议相关技术

### DNS

平常在进行互联网访问的时候，一般都不直接使用IP地址，IP地址这一串没有意义的数字也难以记忆，所以需要DNS来将语义化的域名转换为IP地址。

DNS的实际上的机制类似于互联网当中的分布式数据库，在进行查找的时候，首先访问主机设置的DNS服务器，如果该服务器查询自己的数据库，如果该服务器不知道查找的域名的IP地址，则将查找请求向上提交，直到找到了IP地址为止，再将IP地址返回给主机，发送IP数据包。

### ARP

在确定了IP地址之后，就可以发送IP数据包了，但是在数据链路层上，进行实际通信的时候还需要了解每个IP地址对应的MAC地址。主机会将接收端的IP地址广播到整个数据链路上面，如果某个设备知道或者符合该IP地址对应的MAC地址，将会返回一个ARP响应给发送端，发送端就了解了该IP地址对应的MAC地址，并且这个MAC地址会被缓存一段时候，以供后面的请求来使用。

在通过子网掩码划分了的网络中，使用ARP来获得MAC地址可以有效减少整个网络上的数据流量，保证网络的通畅。

而针对一些不能够设置IP地址的嵌入式设备来说，有时需要通过RARP来反向获取自己的IP地址，来实现连入互联网的通信。

### ICMP

架构IP网络的时候，要通过ICMP协议来确认网络是否正常工作，以及遇到异常时候的问题诊断。

主要的ICMP消息有下面几种：

* 目标不可达消息：当IP路由器无法将IP数据包发送到目标地址的时候，会给发送端的主机返回一个目标不可达消息，这个消息一般附加一个错误信息，来让主机知道为什么目标不可达。

* 重定向消息：当路由器发现了主机使用了次优的路径来发送了一个IP数据包，那么路由器就会返回一个重定向消息，这个消息中包含了最优的路径信息。

* 超时消息：当IP包首部字段TTL被减为0的时候，路由器会返回一个超时消息给发送端主机，可以用来防止发送的数据包进入的了环路。

* 回送消息：用于进行通信的主机或者路由器之间，判断发送的数据包是否到达了对端的消息，经常使用的ping命令就是使用的这个消息实现的，可以用来判断对端是否可达。

* ICMPv6：ICMPv6中的类型133~类型137的消息叫做邻居探索消息。这个消息可以用于查询IPv6的地址与MAC地址的对应关系。

### DHCP

DHCP可以实现自动设置IP地址以及统一管理IP地址分配的功能。让设备的即插即用变成了可能。

DHCP的通信过程包含三种设备：主机、DHCP客户端、DHCP服务器。首先一台设备连入到了某个子网，该子网的DHCP客户端将会给DHCP服务器发送一个请求设置IP地址的子网掩码的请求，服务器通知可以使用的网络设置，然后客户端返回服务器想要使用刚才接收到的设置，服务器允许该设置，DHCP客户端对主机进行刚才允许的设置。

DHCP中继代理可以实现一部分DHCP服务器的功能，其从服务器中获取一个可以使用的IP地址分配范围，然后在该网络内部，直接由该中继代理进行DHCP的设置。

### NAT

NAT是用来进行内网与外网进行通信的。整个内网使用同一个全局IP地址与多个主机进行通信。一个内网主机想要和一个外网地址进行通信，那么就需要NAT将发送源地址从内网地址转换为全局的IP地址，再发送数据。当内网中有多台主机要同时和外网进行通信，这个时候就会将端口信息也用来做标识，区分不同的通信对象。两个主机和外部的通信使用同一个IP地址，使用不同的端口。NAT路由器中维护一个NAT的地址映射表，当开始通信的时候建立，当通信断开发出FIN包的确认应答信息的时候，从表中删除。

### IP隧道

当对等双方使用IPv6进行通信，而中间的路由只能够使用IPv4的时候，就需要IP隧道功能了。IP隧道可以将IPv6的数据包封装一个IPv4的首部，并且将其发送出去。

## TCP与UDP

### 传输层的作用

#### 传输层定义

类似于网络层的IP首部中包含上层协议的协议编号，来标志要发送的数据包到底是由哪种协议指定的，而在TCP和UDP中，使用端口号来区分传输层上一层的应用层中所要进行处理的具体程序。

#### 通信处理

TCP/IP的众多应用协议大多以客户端/服务端的形式运行。客户端类似于客户的意思，是请求的发起端，而服务端则表示提供服务的意思，是请求的处理端。服务端的程序有必要提前启动来监听相应的端口。

这些服务端程序在UNIX系统中被称为守护进程，比如HTTP的httpd以及ssh的sshd等程序。在UNIX中一般启动inetd守护进程，这个进程接收到客户端请求之后创建新的进程并且转换为sshd等守护进程。

#### 两种传输层协议TCP和UDP

* TCP：面向连接的、可靠的流协议，TCP为了实现可靠传输，采取了顺序控制或者重发控制机制来保证数据包的完整。

* UDP：不具有可靠性的数据报协议。细微的处理会交给上层协议来完成，不能够保证消息一定会到达。

#### TCP和UDP区分

需要可靠性控制的应用程序会使用TCP来完成传输，而类似IP电话，如果使用TCP会导致数据包丢失之后重发，这样会使得通信无法正常进行，如果采用UDP，那么无重发处理的情况下，不会有声音大幅度延迟到达的问题，即使有部分丢包，也只会影响一小部分通信。另外，在广播和多播通信中也会使用UDP而不是TCP。

### 端口号

#### 端口号定义

数据链路和IP的地址，分别指MAC地址和IP地址。一个用来识别一个链路中的不同的计算机，一个用来识别网络中的主机和路由器。传输层的端口号就是用来识别计算机中不同的应用程序的。

#### 通过IP地址、端口号、协议号进行通信识别

针对相同源端口和目标端口的两个不同主机的应用程序，就需要IP地址来辅助进行识别了，如果连IP地址也相同，那么唯一的区分途径就是协议号。

因此，TCP/IP或者UDP/IP通信中常采用五个信息来识别通信。源IP地址、目的IP地址、协议号、源端口号、目的端口号，只要有一样不同，那么就是不同的通信。

#### 端口号如何确定

在实际通信的时候，要事先确定端口号。确定端口号的方法有两种：

* 标准既定的端口号：也叫做静态方法，一些常用的应用协议中会使用一些特定的端口号，比如：HTTP的80，SSH的22，mysql的3306等

* 时序分配法：服务端有必要确定监听的端口号，但是接受服务的客户端没必要确定端口号。这时操作系统会自己分配不冲突的端口号。

#### 端口号与协议

端口号由其使用的传输层协议决定，不同的协议可以使用相同的端口号。数据到达IP之后，会首先检查IP首部中的协议号，再传给相应协议的模块，TCP给TCP模块，UDP给UDP模块等。但是知名端口号与传输层协议并没有什么关系，只要端口一致就发送给响应的程序进行处理。

### UDP

UDP是User Datagram Protocol的缩写，不提供复杂的控制机制，利用IP提供面向无连接的通信服务。并且将应用程序发来的数据在收到的那一刻，立即进行原样发送到网络上的机制。即使在网络拥塞的情况下，也无法进行拥塞控制。所有的控制都完全依靠应用程序。

由于UDP的简单高效，一般用于包总量较少的通信、即时通信、广播通信等。

### TCP

TCP是对传输、发送、通信等进行控制的协议。可以在丢包的时候进行重发控制、还可以对乱序的分包进行顺序控制，并且需要确定通信对端存在的时候才会发送数据。这样才能够在IP这样的无连接网络上实现可靠传输。

#### 通过序列号与确认应答提高可靠性

在TCP中，当发送端数据到达主机的时候，接收端主机会返回一个已经收到消息的通知，这个消息称为确认应答`ACK`。

当发送端将数据发出之后会等待对端的确认应答，这个确认应答中包含下个需要接受的段的序号，如果在一定时间内没有等到确认应答，发送端会认为数据已经丢失，并且进行重发。

确认应答、重发控制以及重复控制等都可以通过序列号实现，序列号是按顺序发送给数据的每一个字节都标上号码的编号。接收端查询接收数据TCP首部中的序列号和数据长度，将自己下一步应该接收的序号作为确认应答返送回去。来实现可靠传输。

#### 重发超时如何确定

重发超时是指在重发数据之前，等待确认应答到来的那个特定的时间间隔。TCP要求无论在何种情况下都保证高性能的通信，所以会在每次发包的时候计算往返时间以及抖动，用往返时间及抖动相加得到的时间再稍微大一点，就可以得到重发超时时间。

另外，数据也不会无限、反复地重发，达到一定重发次数之后，如果仍然没有响应，就会判断对端或者网络发生了异常，强行关闭连接，并且通知应用通信异常终止。

#### 连接管理

1. 客户端发送SYN包来请求建立连接
2. 服务端接收到SYN之后，返回客户端一个ACK来确认对于SYN的应答以及一个SYN，请求建立连接
3. 客户端发送一个针对SYN的ACK确认应答

4. 客户端在需要切断连接的时候，发送一个FIN，请求切断连接
5. 服务端发送一个ACK来确认FIN的请求
6. 服务端发送一个FIN来请求切断连接
7. 客户端对于服务端的请求切断连接来返回一个ACK，确认切断连接

#### TCP以段为单位发送数据

在建立TCP连接的同时，也要确定发送数据包的单位，叫做最大消息长度MSS。MSS是在三次握手的时候，在两端主机之间计算得出的。两端主机会告诉对方自己的接口能够适应的MSS大小，然后在两个之间选择一个较小的值进行使用。

#### 窗口

TCP在发送数据的时候以段为单位发送，但是这样会导致每发送一次都要一次ACK来进行确认，浪费了网络流量，窗口大小就是指无需等待确认应答而可以继续发送数据的最大值。这个机制使用缓冲来对多个段进行同时的确认应答。

#### 窗口控制与重发控制

在使用窗口控制的时候，如果出现了段丢失，如果是因为确认应答未能返回，那么也不一定需要重发，因为之后的确认应答会通知客户端已经接收到消息，接收端会进行窗口检查。

如果是报文段丢失，接收主机如果收到一个自己应该接收的序号之外的数据，会针对当前为止收到数据返回确认应答。当发送端连续3次接收到同一个确认应答，那么就会将其所对应的数据进行重发。

#### 流控制

发送端根据自己的实际情况发送数据。接收端可能因为正在处理其他数据包而不能够处理其他数据导致数据被丢弃，这样又会触发重发机制，导致了网络流量的浪费。

为了防止这种情况，TCP提供了让发送端根据接收端实际接受能力控制发送的数据量，也就是流控制。接收端主机向发送端主机通知自己可以接收数据的大小，于是发送端会发送不超过这个限度的数据。这个大小的限度就是窗口大小。

TCP首部当中有一个专门来表示窗口大小的字段，接受主机将自己可以接收的缓冲区大小放入这个字段中通知给发送端。

如果接收端的缓冲区面临数据溢出的时候，窗口大小会随之被设置为更小的值通知给发送端，来控制数据发送量。

如果窗口更新通知在传送的时候丢失，可能导致无法通信，为了避免这个问题，发送端主机会定时发送一个窗口探测数据段，来获取窗口大小信息。

#### 拥塞控制

有了TCP窗口控制，收发主机之间不会再以数据段为单位发送确认应答，也可以发送大量数据包。然而，如果在通信刚开始的时候就发送大量数据，可能会导致网络的拥塞。

TCP为了防止这个问题，在通信开始就会通过慢启动算法来得到数据，对发送的数据量进行控制。

在慢启动的时候，拥塞窗口的大小设置为1个MSS发送数据，每收到一次ACK，拥塞窗口的值就加1，在发送数据包的时候，将拥塞窗口大小与接收端主机通知的窗口大小做比较，然后按照较小的值，发送比起更小的数据量。

如果重发采用超时机制，那么拥塞窗口的初始值可以设置为1，然后再进行慢启动修正。

#### 提高网络利用率的规范

* Nagle算法：该算法指发送端即使还有应该发送的数据，但如果这部分数据很少，那么就进行延迟发送的机制。也就是满足如下两个条件，进行延迟发送：已经发送的数据都收到了确认应答，以及可以发送MSS的数据。

* 延迟确认应答：接收数据的主机如果每次都立即回复确认应答的话，可能会返回较小的窗口，因为缓冲区已满。延迟限制由两个因素控制：在没有收到2MSS的数据为止不确认应答，或者延迟0.5S左右。

* 捎带应答：有些应用层协议，当数据发送到对端的时候，对端会返回一个回执，可以将确认应答和回执数据通过一个包发送。捎带应答必须要延迟确认应答的支持。

### UDP首部的格式

* 源端口号：表示发送端端口号的16位字段，在不需要返回的通信当中会被设置为0

* 目标端口号：16位。

* 包长度：保存了UDP首部长度与数据长度的和，单位为8位字节，占16位。

* 校验和：接收主机在收到UDP数据包之后，从IP首部获知IP地址信息，构造UDP伪首部，再进行校验和计算。伪首部由源IP地址(32位)、目的IP地址(32位)、一位0填充、15位协议号以及16位UDP包长度组成，然后以16位为单位进行1的补码和进行计算得到的。

因为UDP首部中仅有五个标识位中的两个，也就是源端口号和目标端口号，如果要保证报文能够合理地发到每个应用，就需要对协议号、源和目的IP地址进行校验，所以将这些信息放在伪首部里面，通过UDP校验和以及TCP校验和进行校验。防止这些信息出现问题。

### TCP首部格式

* 源、目的端口号

* 序列号：标记发送数据的位置，每发送一次数据，就累加一次该数据字节数的大小，长32位。

* 确认应答号：表示下一次应该受到的数据的序列号，32位。

* 数据偏移：表示TCP传输的数据部分应该从TCP包的那个位开始，其实也就是标记了TCP首部的长度。长4位，单位为4个字节。

* 保留：用于以后的扩展，目前全部被设置为0，长度为4位。

* 控制位：表示包的类型，共8位，分别代表CRW/ECE：用于设置拥塞窗口，URG：紧急处理数据，ACK/SYN/FIN：用于建立连接和断开连接。PSH：表示是否可以缓存，RST：该位为1表示连接出现异常，必须强制断开连接。

* 窗口大小：16位，用来通知从相同的TCP首部的确认应答号所指位置开始能够接受的数据大小。

* 校验和：类似于UDP的校验和，但是TCP校验和不能够关闭，也采用TCP伪首部进行校验。

* 紧急指针：标记报文中紧急数据的指针。

* 选项：选项字段用于提高TCP的传输性能